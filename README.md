# 电子书管理助手

本项目是一个功能强大的电子书管理应用，帮助用户导入、组织和阅读电子书。基于Android平台开发，使用现代Jetpack Compose UI框架构建。

## 技术栈
- Android Studio Ladybug （Build AI-242，属于 2024 年 Q2 版本）
- AGP (Android Gradle Plugin):8.8.2
- Gradle:8.11
- 所有开发的代码需在符合以上技术栈的前提下，尽量采用主流的、先进的技术，且确保各软件包/软件库的版本是匹配的。不要使用不推荐的、过时的技术！

### 开发语言选择
 **Kotlin**

###  开发环境
  Windows10，Android Studio，Cursor，bash，power shell

###  测试终端
手机：华为P30 Pro

###  编码
- 默认编码： **UTF-8**
- windows命令脚本（bat文件）的编码为ANSI，以及特殊说明的以外，其它所有文本文件的编码都是：UTF-8

###  使用环境
以中国大陆为主，不考虑使用GooglePlay服务。

### 架构模式
推荐使用 **MVVM (Model-View-ViewModel)** 架构：
- 使用 Android Jetpack 组件如 ViewModel, LiveData, Room 等
- 实现关注点分离，更易于测试和维护
- 配合 Data Binding 可以减少样板代码

### 用户界面
-. **Jetpack Compose**
   - Android 现代声明式UI框架
   - 简化UI开发，减少样板代码
   - 强大的组件复用能力，适合构建复杂UI
- **开发语言**：Kotlin
- **UI框架**：Jetpack Compose
- **架构模式**：MVVM (Model-View-ViewModel)
- **依赖注入**：手动依赖注入
- **后台处理**：WorkManager
- **数据持久化**：Room Database
- **异步处理**：Coroutines & Flow


## 功能需求
###  主页面
- 底部导航菜单（高度64dp）：包括4个功能图标：书架、书库、历史、设置；
- 书架：是默认主页面，包括顶部导航栏、书籍列表、底部导航栏。顶部导航栏左边显示"我的书架"，右边显示搜索图标和三个点的菜单按钮图标，点击后弹出菜单包括新建文本、网址导入、本地导入、书架管理、书籍排序。书籍列表默认按照添加日期（addedDate）倒序排列。
- 书库：访问公共目录的书籍，待开发
- 历史：阅读历史，按照最后阅读时间(lastOpenedDate)倒序排列。
- 设置：软件设置功能，待完善。

###  书籍列表
- 长按书籍列表的任意一本书，会触发批量操作，即每一本书的右边出现复选框，用户可以进行勾选；另外，在顶部导航栏的右边，原来的搜索图标、以及三个点图标消失，取代它们的是："批量删除图标"、"全选图标"、"取消按钮"。
- 点击批量删除图标，弹出提示框："是否确认删除这x本书籍？ （复选框，默认未选择）同时删除书籍文件"，用户点确认，则删除books数据表的书籍数据。如果同时选择了"同时删除书籍文件"，则同时将书籍文件一并删除。
- 用户点击全选图标，则书籍右边所有的复选框都勾选上。全选图标会变成全部取消图标。
- 用户选择"取消按钮"，则书籍右边的复选框消失，在顶部导航栏的右边，恢复原来的搜索图标、以及三个点图标。
- 点击顶部导航栏的三个点菜单，在菜单最下方可以看到"批量操作"选项，点击后将进入批量操作模式，效果等同于长按书籍。


###  电子书导入
- **电子书导入**：支持导入EPUB、PDF、MOBI、TXT、MD等主流电子书格式。

####  本地导入
1. 点击应用主界面底部导航栏中的"书架"选项卡。
2. 点击书架页面上的"导入"按钮。
3. 在弹出的文件选择器中选择您想要导入的电子书文件。
4. 应用将自动处理文件导入，包括元数据提取和封面生成。
5. 导入完成后，电子书会出现在书架中。

####  网址导入
1. 访问网址对应的网页，提取HTML的中的文本内容，为了优化文本格式，需要将<br>、<P></P>这些换行符转换成\r\n换行符，如果文本的前n行为空行，则自动删除。 然后将第1行文本内容作为标题，居中显示。之后的各行，前面都空出2个字符，表示段落的开始；
2. 在书架里的导入数据，标题不再是web开头字符串，而是文本的第1行内容；
3. 元数据保存时，需将网址保存到书籍表 (books)的urlPath字段；
4. 书籍文件保存到外部公共目录Documents\WanderReads目录的webbook目录下。

#### 网址导入HTML转MD格式技术实现
网址导入功能通过`WebBookImporter`类实现，主要处理流程如下：

1. **网页获取与解析**：
   - 使用JSoup库获取网页内容，设置超时时间为30秒
   - 实现了重试机制，最多尝试3次，使用指数退避策略增加重试间隔
   - 设置用户代理(User-Agent)模拟浏览器请求，增加网页获取成功率

2. **内容提取与格式化**：
   - 移除不需要的HTML元素：脚本、样式表、iframe、导航栏、页脚、页眉等
   - 优先提取文章主体内容，通过选择器定位article、.content等主要内容区域
   - 如未找到特定内容区域，则使用整个body内容
   - 处理HTML标签转换为文本格式：
     - 将`<br>`标签转换为换行符
     - 在`<p>`标签前后添加换行符
     - 在`<div>`标签前添加换行符
     - 在标题标签(`<h1>-<h6>`)前后添加换行符
     - 在列表项(`<li>`)前添加"• "符号
     - 将粗体标签(`<b>`,`<strong>`)内容用"**"包围

3. **文本格式优化**：
   - 移除HTML标签后，进一步处理文本：
     - 在句号、问号、感叹号后添加换行
     - 移除多余空格
     - 删除开头的空行
     - 提取第一行作为标题
     - 其余各行前添加两个空格表示段落开始
     - 每个段落后添加空行

4. **文件保存策略**：
   - 根据Android版本采用不同的存储策略：
     - Android 11+：使用MANAGE_EXTERNAL_STORAGE权限访问外部存储
     - Android 10：尝试legacy方式访问或使用应用专属目录
     - Android 9及以下：直接访问外部存储
   - 保存路径优先级：
     1. 外部公共目录：Documents/WanderReads/webbook/
     2. 应用专属外部目录（Android 10）
     3. 应用私有目录（最终备用方案）

5. **元数据处理**：
   - 提取文本第一行作为书籍标题
   - 保存原始URL到书籍的urlPath字段
   - 生成文件哈希值用于去重检查

6. **异常处理**：
   - 网络异常处理：超时、连接失败等
   - 存储权限处理：根据Android版本检查相应权限
   - 文件操作异常：创建目录失败、写入失败等

通过这种方式，应用能够将网页内容转换为格式良好的文本文件，保留必要的段落结构，并作为电子书添加到书架中。

### 新建文本、
1. 点击书架页面右上角的菜单按钮。
2. 选择"新建文本"选项。
3. 在弹出的对话框中输入文本内容。
4. 点击"确定"按钮保存文本。
5. 文本将被保存为TXT文件并自动添加到书架中，以第一行非空文本内容为书名。

### 修改文本
- 在打开阅读界面后，点击右上角的三个点，增加一个功能链接"修改文本"，放在下拉菜单的第一项。
- 点击修改文本，弹出修改文本窗口，窗口内加载书籍的文本内容，输入框下方有"取消"和"确定"按钮，点击"确定"后，保存修改的文本到数据库，并关闭窗口，同时重新刷新阅读界面的文本。

### 打开网址
1. **功能触发条件**：
   - 在阅读界面，当书籍的urlPath字段不为空时，菜单中显示"打开网址"选项
   - 该选项位于"修改文本"选项之后，点击后使用WebView打开对应网址

2. **技术实现**：
   - 在UnifiedReaderScreen中检查uiState.book?.urlPath是否为空
   - 不为空时，在下拉菜单中添加"打开网址"选项
   - 点击该选项时，使用navController导航到WebView页面
   - WebView页面使用传入的URL参数加载网页内容

3. **用户体验**：
   - WebView页面提供了完整的网页浏览体验，包括页面加载指示器
   - 顶部工具栏显示网页标题，并提供返回按钮
   - 支持网页内容的TTS朗读功能
   - 点击页面可以切换工具栏的显示状态

### **书架管理**：待完善。

### **书库**
#### 书库一级界面
- 点击主页的底部导航栏的书库图标，进入书库界面，一级页面列出以下几个分类名称：新建文本书籍、网址导入书籍、本地导入书籍、合成语音文件。分类名称左边有一个合适的图标，分类名称右边是文件的数量、文件浏览器图标。点击文件浏览器图标，可以打开系统自带的文件浏览器，自动定位到对应的目录。

#### 书库二级界面
- 点"新建文本"，列出Documents\WanderReads\txtfiles目录下的文件，包括文件名、创建时间、文件大小。
- 点"网址导入"，列出Documents\WanderReads\webbook目录下的文件，包括文件名、创建时间、文件大小。
- 点"本地导入"，列出Documents\WanderReads\books目录下的文件，包括文件名、创建时间、文件大小。
- 点"语音文件"，列出Documents\WanderReads\voices目录下的文件，包括文件名、创建时间、文件大小。
- 以上文件列表，可以进行删除、修改文件名操作，以及批量删除操作。
  - 点击右上角的"选择"或长按文件名称，进入选择模式，右上角会出现删除图标、全选图标和"取消"按钮。
  - 点击全选图标，会将文件列表复选框全部选中，此时全选图标变成取消全选图标。
  - 点击取消全选图标，会将文件列表复选框全部取消选择。
  - 点击删除图标，会弹出确认对话框，显示"选定的X个文件即将被删除，且不可恢复，是否确认删除？"，用户可选择"确认删除"或"取消"。
  - 对单个文件的删除操作也会弹出类似的确认对话框。
- 对于合成语音文件，可以进行设置闹钟操作。
  - 在语音文件列表中，点击文件名称右侧的"..."菜单，选择"设置闹钟"选项
  - 系统会打开闹钟设置界面，自动将选中的语音文件设置为闹钟铃声
  - 用户可以在闹钟设置界面调整闹钟时间、重复规则等其他设置
  - 支持主流Android设备的闹钟应用，包括原生Android、Google、三星、华为、OPPO、vivo等品牌

- 书库的二级界面中的文件列表，点击文件名称右侧的"..."菜单，如果是语音文件，弹出菜单为：所属目录、播放语音、重命名、删除、设置闹钟。如果是其它文件，弹出菜单为：所属目录、重命名、删除。 用户点击所属目录，则弹出系统默认的文件浏览器，并自动打开文件所在目录，并定位到当前这个文件。


### 阅读历史
1. 点击首页底部导航菜单中的"历史"，打开阅读历史列表。不需要专门设计阅读历史的数据表，只筛选书籍表 (books)中最后打开日期(lastOpenedDate)非空的记录查询出来，按照lastOpenedDate倒序排列即可。
2. 历史列表显示与我的书籍基本相同，不同之处在于书籍图片的右边第3行是显示最近阅读日期（lastOpenedDate）。

###  设置
#### 语言设置
#### 主题样式
##### 关于应用，具体内容从上往下为：
1. 最上方是LOGO图标（居中）
2. 应用中文名：漫阅
3. 应用英文名和版本号：Wander Reads v0.19
4. 应用简介：本应用提供电子书导入、文本输入和阅读功能，同时支持TTS朗读和合成语音功能，目前应用仍在不断升级和完善中，欢迎使用并提出改进意见或建议。
5. 作者：hunt2035

##### 更新日志：显示历次的更新日志列表


### 阅读电子书的相关界面

#### 阅读界面的两种状态
1. **全屏阅读界面**
    - 全屏阅读界面样式：从书籍点击一本书籍后，进入全屏阅读界面，全屏基本都是正文内容，但底部保留高度很窄的一行状态栏（高度设置为32dp），左右分为两部分，左边占比2/3宽度显示书籍名称（名称显示不下时，后面加三个点）使用半透明白色（alpha = 0.7f），文字使用小号字体（bodySmall）。右边1/3宽度显示页码（例如：2/13，页码从1开始计数）和阅读百分比（例如：68.1%）。在全屏阅读界面，始终不会出现音频播放控件。
    - "全屏阅读界面"何时转变为"带工具栏的阅读界面"：点击**全屏阅读界面**的中间区域（屏幕中间1/3区域），则进入"带工具栏的阅读界面"。

2. **带工具栏的阅读界面**
    - 带工具栏的阅读界面样式：阅读界面出现顶部工具栏和底部工具栏，APP判断全局TTS状态如果等于"朗读状态"或"暂停状态"，则出现朗读控制悬浮控件。
    - "带工具栏的阅读界面"何时转变为"全屏阅读界面"：无论点击阅读内容的任何一个区域，不再响应翻页的指令，都是让顶部工具栏、底部工具栏以及朗读控制悬浮控件（如有的话）同时消失。

##### 顶部工具栏
- 顶部工具栏从左到右，显示左箭头（返回），章节名称， 顶部工具栏的最右边显示三个点图标。 点击三个点图标，弹出菜单，包括这几个菜单项：修改文本、查看目录、开始朗读、合成语音、语音列表、分享内容、阅读设置。

##### 底部工具栏
1 底部工具栏分为上下两行。
2 底部工具栏的第1行，从左至右显示：左箭头（点击可以翻页到上一页），滑杆（中间有个圆点可以左右拖动，控制翻页进度，圆点位置占比与页码/总页数比例需一致），右箭头（点击可以翻页到下一页）。
3 底部工具栏的第2行，放置各种操作图标，从左到右依次是：
   - 目录图标：点击可以弹出目录链接；
   - 朗读图标：点击后从本页开始朗读；
   - 合成语音图标：TTS语音合成；
   - 语音列表图标：列出并管理合成的语音；
   - 阅读设置图标：可设置字体大小、行间距、TTS语速等。


### TTS朗读与**音频播放控件**
#### 全局TTS状态
- TTS朗读是全局事件，且类似于后台服务，翻页时或切换到APP的其它页面时，朗读不会受影响，翻页也不会重新发起TTS调用，而是继续进行之前的阅读内容，直到读完所有的内容。
- 全局TTS状态共三种，1）停止状态（STATUS_STOPPED = 0）；2）朗读状态（STATUS_PLAYING = 1）；3）暂停状态（STATUS_PAUSED = 2）。在TTS的状态有变化时，app需要随时记录下TTS的状态。app可以根据TTS的状态确定UI及按钮的状态。
- 能够改变TTS的3种状态的操作，包括：1）用户点击底部工具栏的"朗读本页"；2）用户点击音频播放控件的暂停/播放或停止按钮；3）完成播放；4）播放异常中断。 TTS的3种状态，也需同步更新UI的按钮状态。

#### 全局TTS状态与UI的关系
- **音频播放控件**：两边是半圆形，从左到右分别是圆形的封面，文字按钮("边听边看"或"同步中...")，播放前一句（<）、播放按钮（▶）/暂停按钮（⏸）、播放后一句（>）、关闭按钮（❌）。
- 在**全屏阅读界面**（即无顶部工具栏和底部工具栏时），音频播放控件隐藏。
- 在**带工具栏的阅读界面**，app判断TTS的状态：如果是停止状态，则音频播放控件隐藏；如果TTS是朗读状态，则音频播放控件可见，且显示暂停按钮（⏸）；如果TTS是暂停状态，则音频播放控件可见，且显示播放前一句（<）、播放按钮（▶）、播放后一句（>）、关闭按钮（❌）。

-. 底部工具栏上，用户点击文字按钮"朗读本页"后，开始朗读，全局TTS状态变为朗读状态，此时，文字按钮颜色变灰色，不可点击，同时文字变成"朗读中..."。
-. 当全局TTS状态变成暂停状态时，底部的朗读按钮又恢复成"朗读本页"，且可以点击了，用户点击后，首先自动关闭之前的朗读，然后重新朗读本页，全局TTS状态又变更为朗读状态，且朗读的位置更新为从本书的本页开始。
-. 当全局TTS状态变成停止状态时，底部的朗读按钮又恢复成"朗读本页"，且可以点击了，用户点击后，又重新朗读本页，全局TTS状态又变更为朗读状态，且朗读的位置更新为从本书的本页开始。

- 当全局TTS状态等于 朗读状态（STATUS_PLAYING = 1）或 暂停状态（STATUS_PAUSED = 2）时，在书架界面和书库界面的底部导航栏的上方，会出现**音频播放控件**，紧贴着底部导航栏，用户点击音频播放控件的“边听边看”，可以立即跳转到正在朗读的书籍的当前页面。

- 悬浮控件支持被拖动到在整个阅读界面的任意位置。
- 内存优化：TTS停止时需释放相关资源。


#### 当前阅读的位置和当前TTS朗读的位置 相关的变量梳理：
1. 用户在阅读时打开书籍页面或进行翻页（包括在全屏阅读界面点左、右区域进行翻页，或在带工具栏的阅读界面，点击左右翻页键进行翻页，或拖动翻页滑杆进行翻页）。用户翻阅书籍时，看到哪一页，当前的阅读的位置就更新到哪里。此时需要把当前翻页的位置记录到全局变量中，包括:
    - readBookId：当前阅读的书籍ID
    - readCurrentPage：当前朗读的页码
    - readTotalPages：总页数

2. TTS朗读时，打开书籍页面或进行自动翻页，TTS朗读书籍内容时，朗读到哪一页，当前的朗读的位置就更新到哪里。此时需要把当前朗读的位置记录到全局变量中，包括
  1）在TtsManager.kt中定义变量名称：
    - currentBookId：当前朗读的书籍ID
    - currentPageIndex：当前朗读的页码
    - currentText：当前朗读的文本内容
    - currentSentenceIndex：当前朗读的句子索引
  2）在于TtsManager单例中，在应用范围内是全局的暴露为公共状态的部分：
    - bookId：当前朗读的书籍ID
    - currentPage：当前朗读的页码
    - pageCompleted：当前页是否朗读完成

3. 在TtsManager中设置一个全局变量IsSyncPageState：
- 变量取值是：如果全局TTS状态为停止，则IsSyncPageState=-1；如果全局TTS状态为朗读状态或暂停状态，并且TTS朗读位置的书籍和页码等于用户当前阅读的页面的书籍和页码（即readBookId=currentBookId，且readCurrentPage=currentPageIndex），则变量等于1；否则IsSyncPageState=0。当APP不在阅读界面时（例如在书架界面），IsSyncPageState也等于0。 每当书籍的页面新加载（包括用户首次打开书籍页面或翻页打开书籍页面），或离开阅读界面时，就进行判断并更新IsSyncPageState值。
- TTS朗读时，若全局变量IsSyncPageState=1，则当前朗读的句子需高亮显示，且朗读的句子与高亮的句子需要保持同步。

#### 当前阅读的位置和当前朗读的位置之间的关系
1. 当前阅读的位置完全由用户的操作决定，即用户当前翻阅的书籍的页面在哪里，决定了当前阅读的位置；当前朗读的位置，不受用户翻页操作的影响，TTS朗读到书籍的哪一页，朗读的位置就在哪里，它可以是在后台进行的。
2. 当前阅读的位置 与 当前朗读的位置 可能相同，也可能不同。
3. 如果当前用户阅读的页面与当前朗读的页面同步（即全局变量IsSyncPageState=1），则**音频播放控件**（如果可见）里的文字按钮显示"同步中..."，文字的背景改为浅蓝色，文字按钮不可点击。同时，TTS朗读或暂停时的文字高亮功能起作用。
4. 如果当前用户阅读的页面与当前朗读的页面不同步（即全局变量IsSyncPageState=0），则**音频播放控件**（如果可见）里的文字按钮显示"边听边看"，文字的背景改为深蓝色，点击"边听边看"文字按钮则页面立即切换到当前朗读的书籍的对应页面(currentBookId和 currentPageIndex对应的页面)。
5. TTS朗读完一页，自动翻页，需要遵循的规则：若IsSyncPageState=1（即朗读页面与用户查看的页面一致），则TTS在前台自动翻页，需继续保持朗读的页面与用户当前查看的页面一致（即IsSyncPageState=1）；若IsSyncPageState=0（即朗读页面与用户查看的页面不一致），则TTS在后台自动翻页，不影响前端UI。


### TTS朗读功能

#### 自动翻页机制

WanderReads的TTS朗读功能支持自动翻页，即使用户退出阅读界面返回到书架页面，TTS朗读完当前页后也能自动翻到下一页并继续朗读。这是通过将自动翻页逻辑从ViewModel移到TtsService中实现的：

1. **TtsService**：作为前台服务运行，生命周期独立于UI界面，负责：
   - 监听TTS状态变化
   - 在页面朗读完成时自动翻页
   - 加载和管理BookReaderEngine
   - 在通知栏显示当前朗读状态和书籍信息
   - 提供通知栏控制按钮（播放/暂停、停止）

2. **TtsManager**：全局单例，负责：
   - 管理TTS引擎
   - 提供TTS状态流
   - 提供重置pageCompleted标志的方法

3. **UnifiedReaderViewModel**：不再处理自动翻页逻辑，只负责：
   - 启动和绑定TtsService
   - 监听TTS状态变化，但不处理自动翻页

4. **MainActivity**：维护全局阅读位置，供TtsService使用：
   - readBookId：当前阅读的书籍ID
   - readCurrentPage：当前阅读的页码
   - updateReadingPosition：更新阅读位置的方法

#### 通知栏体验

为了提供简洁的用户体验，应用只在通知栏显示TTS朗读相关的通知，语音合成等其他操作在后台静默进行，不会显示在通知栏中。TTS朗读通知提供以下功能：

1. 显示当前朗读的书籍信息和状态
2. 提供播放/暂停按钮，方便用户控制朗读
3. 提供停止按钮，可随时停止朗读
4. 点击通知可直接返回到正在朗读的书籍页面

#### 使用方法

1. 在阅读界面点击"朗读"按钮开始TTS朗读
2. TTS会自动朗读当前页面内容
3. 朗读完成后自动翻页并继续朗读
4. 即使退出阅读界面，TTS也会继续在后台朗读并自动翻页
5. 通知栏会显示当前朗读状态和书籍信息
6. 点击通知可返回到正在朗读的书籍页面
7. 通知栏提供播放/暂停和停止按钮，可直接控制TTS朗读

#### 自动翻页流程

1. TtsService监听TtsManager的ttsState流
2. 当检测到pageCompleted=true时，调用handlePageCompleted方法
3. handlePageCompleted方法:
   - 确保有可用的BookReaderEngine
   - 检查是否有下一页
   - 如果有下一页，重置pageCompleted标志，翻到下一页并开始朗读
   - 如果已到最后一页，停止朗读


### TTS语音合成：
- 用户点击语音合成图标，弹出合成界面，合成范围包括当前页（默认）和当前章节，语音设置包括语速、音调、音量，用户点开始合成，合成语音操作开始在后台进行，在语音合成和文件保存的过程中，显示完成百分比（模拟从1%到100%不断增长变化）向用户反馈操作的进展情况，文件合成并保存成功后，弹出页面显示"语音合成成功，生成文件位于目录xxxx下"，如果合成失败，则在页面显示失败原因。用户点击关闭按钮后关闭页面。

### 合成的语音列表
- 用户点击语音列表图标，进入合成语音列表界面
- 语音文件按照生成时间倒序排列，每一条语音有2行信息，第1行显示文件名、时长；第2行显示生成时间、波形图、文件大小。
- 从左到右为：倒退图标（点击后可倒退语音15秒）、播放▶或暂停⏸按钮（如播放时点击后则语音暂停，如语音停止时点击则语音继续播放）、快进图标（点击后可前进语音15秒）、重命名图标、删除图标。
- 如语音停止时，按钮是▶，用户点击后则语音继续播放，且按钮变为⏸。
- 如播放语音时，按钮是⏸，用户点击后则语音暂停，且按钮恢复为▶。
- 播放时显示实时进度条，包括起始时间、播放时间和剩余时间，可以拉动滑杆的圆点调节播放进度。
- 支持文件重命名和删除操作，删除操作会同时删除数据库记录和实际文件
- 文件重命名操作会同时修改数据库记录和实际文件名


### 分享阅读内容
1. 在书架中打开任一电子书，进入阅读界面。
2. 点击屏幕中间区域显示顶部工具栏。
3. 点击顶部工具栏中的"分享"图标。
4. 系统会显示可用的分享应用列表，选择您想要分享到的应用（如微信、QQ、微博等）。
5. 为保持良好的分享体验，文本内容超过300字会自动截断并在末尾添加省略号。



## 非功能性需求
1. 关注页面渲染性能，提供流畅翻页效果
2. 如遇到大文件处理（例如超过10MB），需分块加载内容，避免一次性加载整本书
3. 对于不同格式电子书的解析，使用专门的库处理不同格式，创建统一接口抽象不同实现
4. 注意内存使用优化、启动时间优化、UI性能优化；避免出现内存泄露问题



## 项目结构

```
app/src/main/java/com/wanderreads/ebook/
├── data/            # 数据层，包含存储库和数据源
├── domain/          # 领域层，包含模型和业务逻辑
├── ui/              # 表现层，包含视图和ViewModel
│   ├── bookshelf/   # 书架相关UI组件
│   ├── importbook/  # 导入界面相关组件
│   ├── reader/      # 阅读器相关组件
│   ├── navigation/  # 应用导航组件
│   └── theme/       # UI主题定义
├── util/            # 通用工具类
└── worker/          # 后台工作任务
```

## 数据存储结构

应用将电子书和相关数据保存在Android外部存储的Documents目录下的WanderReads文件夹中，即使卸载应用后，这些数据也会保留。结构如下：

```
Documents/WanderReads/
├── books/       - 存储电子书文件
├── covers/      - 存储封面图片
├── webbook/     - 存储网页导入的文本文件
├── txtfiles/       - 新建文本
├── voices/       - 存储合成的语音文件
└── config/      - 存储配置文件（未实现）
```

应用内部私有目录仅用于存储：
```
/data/data/com.wanderreads.ebook/
└── cache/       - 临时缓存数据
```

## 生成的文件的命名规则

应用使用统一的文件命名规则，确保文件名的一致性和可读性：

### 新建文本和网址导入文件
- **命名规则**：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .md
- **示例**：小猪佩奇_2503213856.md
- **说明**：使用md扩展名以便后续使用markdown格式进行解析

### 合成语音文件
- **命名规则**：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .mp3
- **示例**：小猪佩奇_2503213856.mp3
- **说明**：与文本文件命名规则保持一致，仅扩展名不同

### 本地导入文件
- **命名规则**：原文件名(不含扩展名)前20个字符 + 下划线 + 4位随机数 + .原扩展名
- **示例**：小猪佩奇_3856.epub
- **说明**：保留原文件扩展名，确保文件类型不变

所有文件名中的特殊字符（\/:*?"<>|）都会被替换为下划线，以确保文件名在各种文件系统中的兼容性。


## 许可证

本项目采用MIT许可证。详见LICENSE文件。


## 阅读器架构

本应用采用了抽象工厂模式和策略模式设计阅读器功能，实现了格式无关的统一阅读体验。

### 核心组件

- **BookReaderEngine**：所有阅读引擎的抽象接口，定义统一的功能
- **TxtReaderEngine**：TXT文件阅读引擎实现
- **EpubReaderEngine**：EPUB文件阅读引擎实现
- **ReaderEngineFactory**：根据文件格式创建对应的阅读引擎
- **UnifiedReaderViewModel**：统一的阅读器视图模型，处理所有格式
- **UnifiedReaderScreen**：统一的阅读器界面

### 架构优势

1. **代码复用**：翻页控制、文本转语音、查看目录等通用功能只实现一次
2. **统一用户体验**：所有格式的阅读界面保持一致
3. **易于扩展**：添加新格式只需实现新的引擎类，不需修改UI代码
4. **易于维护**：避免功能重复实现导致的bug和不一致问题



## Gradle配置说明

本项目使用了最新的Android Gradle Plugin 8.8.2和Gradle 8.11版本，适配Android Studio Ladybug (Build AI-242)。配置文件已经进行了以下优化：

### 关键配置文件
- `build.gradle.kts`：根项目构建文件，包含插件管理和全局设置
- `app/build.gradle.kts`：应用模块构建文件，包含应用配置和依赖项
- `gradle/libs.versions.toml`：依赖版本控制，集中管理所有库版本
- `gradle.properties`：Gradle属性配置，包含JVM参数和网络设置
- `settings.gradle.kts`：项目设置文件，包含依赖仓库配置

### 常见Gradle问题解决方案

如果在构建过程中遇到以下问题，可以尝试以下解决方案：

1. **构建卡住或失败**：
   ```
   执行 ./restart_gradle.bat 重置Gradle守护进程
   ```

2. **依赖下载失败**：
   配置文件已设置国内镜像源，优先使用阿里云和腾讯云镜像，大幅提高依赖下载速度和成功率。

3. **Gradle版本兼容性问题**：
   本项目已配置使用Gradle 8.11版本，如需更换版本，请同时修改：
   - `gradle/wrapper/gradle-wrapper.properties`
   - `gradle.properties`中的distributionUrl属性

## 最近更新与修复
    记录到changelog.md文件中。

## 后台运行功能

为了确保TTS朗读功能和其他后台任务能够稳定运行，应用提供了两种方式来优化后台运行体验：

### 1. 禁用电池优化

应用请求忽略Android系统的电池优化机制，避免系统在屏幕关闭或长时间未交互时终止应用进程，这主要通过以下方式实现：

- 使用`REQUEST_IGNORE_BATTERY_OPTIMIZATIONS`权限
- 当用户启用"关闭电池优化"选项时，引导用户进入系统设置添加应用到白名单
- 适用于所有Android 6.0+设备

### 2. 厂商特定后台运行设置

针对国内各厂商设备的系统级自启动/后台限制管理：

- 华为设备：引导用户进入自启动管理页面
- 小米设备：引导用户进入自启动管理和省电策略设置
- OPPO设备：引导用户进入自启动管理和耗电保护设置
- VIVO设备：引导用户进入后台高耗电应用管理
- 三星设备：引导用户进入电池使用优化设置
- 联想设备：引导用户进入纯净后台设置

用户可在设置页面中启用"允许后台运行"选项，应用会自动识别设备厂商并引导用户进入对应的系统设置页面。

### 3. 开机自启动

应用支持在设备重启后自动恢复TTS朗读服务：

- 通过`RECEIVE_BOOT_COMPLETED`权限监听设备启动事件
- 当用户启用"允许后台运行"选项时，设备重启后会自动启动TTS服务
- 不会自动打开应用界面，仅在后台恢复必要服务

### 使用方法

1. 进入应用设置页面
2. 开启"关闭电池优化"选项（处理系统级电池优化）
3. 开启"允许后台运行"选项（处理厂商特定限制）
4. 根据系统提示进入对应设置页面进行授权

完成以上设置后，应用的TTS朗读功能将能够在后台稳定运行，不会因为系统的电池优化或厂商特定限制而被终止。


