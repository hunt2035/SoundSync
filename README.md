# 电子书管理助手

本项目是一个功能强大的电子书管理应用，帮助用户导入、组织和阅读电子书。基于Android平台开发，使用现代Jetpack Compose UI框架构建。

## 技术栈
所有开发的代码需在符合以下技术栈的前提下，尽量采用主流的、先进的技术，且确保各软件包/软件库的版本是匹配的。不要使用不推荐的、过时的技术！
- Android Studio Ladybug （Build AI-242，属于 2024 年 Q2 版本）
- AGP (Android Gradle Plugin):8.8.2
- Gradle:8.11

### 开发语言选择
 **Kotlin**

###  开发环境
  Windows10，Android Studio，Cursor，bash，power shell

###  测试终端
手机：华为P30 Pro

###  编码
- 默认编码： **UTF-8**
- windows命令脚本（bat文件）的编码为ANSI，以及特殊说明的以外，其它所有文本文件的编码都是：UTF-8

###  使用环境
以中国大陆为主，不考虑使用GooglePlay服务。

### 架构模式
推荐使用 **MVVM (Model-View-ViewModel)** 架构：
- 使用 Android Jetpack 组件如 ViewModel, LiveData, Room 等
- 实现关注点分离，更易于测试和维护
- 配合 Data Binding 可以减少样板代码

### 用户界面
-. **Jetpack Compose**（推荐）：
   - Android 现代声明式UI框架
   - 简化UI开发，减少样板代码
   - 强大的组件复用能力，适合构建复杂UI
- **开发语言**：Kotlin
- **UI框架**：Jetpack Compose
- **架构模式**：MVVM (Model-View-ViewModel)
- **依赖注入**：手动依赖注入
- **后台处理**：WorkManager
- **数据持久化**：Room Database
- **异步处理**：Coroutines & Flow


## 功能需求
###  主页面
- 底部导航菜单：包括4个功能图标：书架、书库、历史、设置；
- 书架：是默认主页面，顶部导航栏左边显示"我的书架"，右边显示搜索图标和三个点的菜单按钮图标。书籍按照添加日期（addedDate）倒序排列。
- 书库：访问公共目录的书籍，待开发
- 历史：阅读历史，按照最后阅读时间(lastOpenedDate)倒序排列。
- 设置：软件设置功能，待完善。

###  电子书导入
- **电子书导入**：支持导入EPUB、PDF、MOBI、TXT等主流电子书格式。

####  本地导入
1. 点击应用主界面底部导航栏中的"书架"选项卡。
2. 点击书架页面上的"导入"按钮。
3. 在弹出的文件选择器中选择您想要导入的电子书文件。
4. 应用将自动处理文件导入，包括元数据提取和封面生成。
5. 导入完成后，电子书会出现在书架中。

####  网址导入
1. 访问网址对应的网页，提取HTML的中的文本内容，为了优化文本格式，需要将<br>、<P></P>这些换行符转换成\r\n换行符，如果文本的前n行为空行，则自动删除。 然后将第1行文本内容作为标题，居中显示。之后的各行，前面都空出2个字符，表示段落的开始；
2. 在书架里的导入数据，标题不再是web开头字符串，而是文本的第1行内容；
3. 保存时，需将网址保存到书籍表 (books)的urlPath字段；

### 新建文本
1. 点击书架页面右上角的菜单按钮。
2. 选择"新建文本"选项。
3. 在弹出的对话框中输入文本内容。
4. 点击"确定"按钮保存文本。
5. 文本将被保存为TXT文件并自动添加到书架中，以第一行非空文本内容为书名。

### 分享阅读内容
1. 在书架中打开任一电子书，进入阅读界面。
2. 点击屏幕中间区域显示顶部工具栏。
3. 点击顶部工具栏中的"分享"图标。
4. 系统会显示可用的分享应用列表，选择您想要分享到的应用（如微信、QQ、微博等）。
5. 为保持良好的分享体验，文本内容超过300字会自动截断并在末尾添加省略号。

### **书架管理**：待完善。

### 阅读电子书的相关功能
1. 在书架中点击任何一本已导入的电子书。
2. 应用会根据电子书格式自动选择合适的阅读器打开它。
3. 在阅读界面，您可以翻页、调整字体大小、更改主题等。
4. 阅读进度会自动保存，下次打开时会继续上次的阅读位置。
5. TTS朗读模块：
   - 文本朗读控制（开始、暂停、停止）
   - 语速、音调调整
6. 阅读设置模块
    可以设置字体大小、行间距、是否深色模式、是否朗读时进行录音
7. TTS录音功能
     - 在阅读界面顶部导航栏，朗读图标的右边增加一个录音图标（表示未开始录音），用户点击录音图标后即开始录音，图标变成进行录音的图标（最好是有一个动态效果，让用户知道录音在进行中）。当用户再点击进行录音的图标， 则录音停止。 另外录音时，系统侦测到有10秒及以上的静音，则自动停止录音，图标自动恢复成录音图标。
     - 注意：系统进行录音不录话筒的声音，只录制内部语音（即内录），生成mp3文件（文件名voc_+时间戳）
     - 将录音保存到book_records目录中
   - **数据存储**：
     - 使用专门的录音表(records)存储录音元数据
     - 关键字段包括：录音文件主键(rec_id); 书籍主键(book_id，关联book表的id字段); 录音保存路径(voiceFilePath); 录音时长（单位秒）(voiceLenth); 录音创建时间(addedDate)
     - 在生成录音文件后，将录音元数据写入records表
8. 录音文件查看和管理
     - 在阅读界面的顶部导航栏里，有一个"录音文件"图标
     - 点击此图标会弹出当前书籍对应的录音文件列表
     - 录音文件按添加时间倒序排列
     - 每个录音文件右侧有播放按钮，点击可播放/暂停录音
     - 列表显示录音创建时间和录音时长等信息

### 阅读历史
1. 点击首页底部导航菜单中的"历史"，打开阅读历史列表。不需要专门设计阅读历史的数据表，只筛选书籍表 (books)中最后打开日期(lastOpenedDate)非空的记录查询出来，按照lastOpenedDate倒序排列即可。
2. 历史列表显示与我的书籍基本相同，不同之处在于书籍图片的右边第3行是显示最近阅读日期（lastOpenedDate）。


## 非功能性需求
1. 关注页面渲染性能，提供流畅翻页效果
2. 如遇到大文件处理（例如超过10MB），需分块加载内容，避免一次性加载整本书
3. 对于不同格式电子书的解析，使用专门的库处理不同格式，创建统一接口抽象不同实现
4. 注意内存使用优化、启动时间优化、UI性能优化；避免出现内存泄露问题



## 项目结构

```
app/src/main/java/com/wanderreads/ebook/
├── data/            # 数据层，包含存储库和数据源
├── domain/          # 领域层，包含模型和业务逻辑
├── ui/              # 表现层，包含视图和ViewModel
│   ├── bookshelf/   # 书架相关UI组件
│   ├── importbook/  # 导入界面相关组件
│   ├── reader/      # 阅读器相关组件
│   ├── navigation/  # 应用导航组件
│   └── theme/       # UI主题定义
├── util/            # 通用工具类
└── worker/          # 后台工作任务
```

## 未来计划

- 自定义书架分类和标签
- 云端同步
- 批注和笔记功能增强
- 更多电子书格式支持

## 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 阅读器架构

本应用采用了抽象工厂模式和策略模式设计阅读器功能，实现了格式无关的统一阅读体验。

### 核心组件

- **BookReaderEngine**：所有阅读引擎的抽象接口，定义统一的功能
- **TxtReaderEngine**：TXT文件阅读引擎实现
- **EpubReaderEngine**：EPUB文件阅读引擎实现
- **ReaderEngineFactory**：根据文件格式创建对应的阅读引擎
- **UnifiedReaderViewModel**：统一的阅读器视图模型，处理所有格式
- **UnifiedReaderScreen**：统一的阅读器界面

### 架构优势

1. **代码复用**：翻页控制、文本转语音、查看目录等通用功能只实现一次
2. **统一用户体验**：所有格式的阅读界面保持一致
3. **易于扩展**：添加新格式只需实现新的引擎类，不需修改UI代码
4. **易于维护**：避免功能重复实现导致的bug和不一致问题

## 常见问题与解决方案

### 中国大陆使用问题

由于中国大陆网络环境的限制，Google相关服务在中国大陆地区无法正常访问。为保证应用在中国大陆地区的正常使用，我们已经：

1. 移除了对Google Play Services的依赖，包括：
   - play-services-base
   - play-services-auth
   - play-services-safetynet
   - play-services-basement
   - play-services-tasks

2. 取消了应用启动时的安全提供程序更新(ProviderInstaller)，该功能依赖Google Play服务

3. 停用了内部录音功能的Google Play服务检查

请注意，即使已移除这些依赖，某些功能可能仍然受到限制。如果您需要使用依赖Google服务的功能，请考虑：
- 使用非中国大陆区域的网络环境
- 考虑使用国内替代服务实现类似功能

### EPUB解析栈溢出问题

如果在打开某些EPUB文件时遇到以下错误：
```
java.lang.StackOverflowError: stack size 1039KB
```

这通常是由于EPUB文件中的目录结构过于复杂或嵌套层级太深导致的。在版本1.0.1中，我们已经修复了这个问题：

1. 优化了导航点解析逻辑，避免无限递归
2. 限制了目录解析的最大深度
3. 增强了目录项与内容文件的匹配算法

如果您仍然遇到此类问题，可以尝试将问题EPUB文件发送给开发团队进行分析，或者尝试使用其他电子书格式。

### 构建问题解决

如果在构建过程中遇到以下错误：
```
Execution failed for task ':app:clean'.
> java.io.IOException: Unable to delete directory 'D:\ZCHDEV\git\ebook\app\build'
```

这通常是因为某些文件被其他进程锁定，可以尝试以下解决方案：

1. **使用自定义清理命令**：
   ```bash
   ./gradlew forceClean
   ```
   或
   ```bash
   ./gradlew cleanAll
   ```

## Gradle配置说明

本项目使用了最新的Android Gradle Plugin 8.8.2和Gradle 8.11版本，适配Android Studio Ladybug (Build AI-242)。配置文件已经进行了以下优化：

### 关键配置文件
- `build.gradle.kts`：根项目构建文件，包含插件管理和全局设置
- `app/build.gradle.kts`：应用模块构建文件，包含应用配置和依赖项
- `gradle/libs.versions.toml`：依赖版本控制，集中管理所有库版本
- `gradle.properties`：Gradle属性配置，包含JVM参数和网络设置
- `settings.gradle.kts`：项目设置文件，包含依赖仓库配置

### 常见Gradle问题解决方案

如果在构建过程中遇到以下问题，可以尝试以下解决方案：

1. **构建卡住或失败**：
   ```
   执行 ./restart_gradle.bat 重置Gradle守护进程
   ```

2. **依赖下载失败**：
   配置文件已设置国内镜像源，优先使用阿里云和腾讯云镜像，大幅提高依赖下载速度和成功率。

3. **Android Studio同步问题**：
   ```
   执行 ./setup_and_sync.bat 脚本进行环境初始化和同步
   ```

4. **Gradle版本兼容性问题**：
   本项目已配置使用Gradle 8.11版本，如需更换版本，请同时修改：
   - `gradle/wrapper/gradle-wrapper.properties`
   - `gradle.properties`中的distributionUrl属性

### 5. 清除应用数据

如持续遇到问题，可以尝试清除应用数据：
1. 进入设备"设置" -> "应用" -> 找到本应用
2. 点击"存储" -> "清除数据"
3. 重启设备并重新启动应用

如果以上方法仍然无法解决问题，可能是临时的服务器问题，请稍后再试。



