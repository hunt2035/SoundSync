# 更新日志

## 2025-06-15：TTS自动翻页同步状态修复
- **问题修复**：修复TTS朗读完一页自动翻页后同步状态(IsSyncPageState)错误变为0的问题
- **实现内容**：
  1. 优化TtsService中的handlePageCompleted方法，在同步状态下(IsSyncPageState=1)：
     - 先发送广播通知前端UI更新
     - 等待300毫秒确保UI已更新
     - 更新全局阅读位置
     - 然后再开始朗读新页面
  2. 增强TtsManager中的updateSyncPageState方法，添加更详细的日志记录
  3. 改进TtsManager中的startReading方法，检测并修复同步状态从1变为0的情况
- **改进目的**：确保在TTS自动翻页后，如果之前是同步状态(IsSyncPageState=1)，则保持同步状态，使前端UI与TTS朗读位置始终保持一致

## 2025-06-12：TTS自动翻页规则优化
- **功能增强**：优化TTS自动翻页规则，根据同步状态智能决定UI行为
- **实现内容**：
  1. 添加基于IsSyncPageState的翻页逻辑判断：
     - 当IsSyncPageState=1（朗读页面与用户查看的页面一致）时，TTS自动翻页会同步更新UI
     - 当IsSyncPageState=0（朗读页面与用户查看的页面不一致）时，TTS在后台自动翻页，不影响前端UI
  2. 实现广播机制，在需要时通知前端UI更新页面
  3. 优化TtsService中的handlePageCompleted方法，增强日志记录
  4. 在UnifiedReaderViewModel中添加广播接收器处理翻页通知
- **改进目的**：提供更加智能的阅读体验，在用户专注阅读时不打扰，在用户使用TTS跟读时保持同步

## 2025-06-10：TTS自动翻页功能优化
- **功能增强**：优化TTS自动翻页机制，使其生命周期不依赖于特定的ViewModel或UI界面
- **实现内容**：
  1. 将自动翻页逻辑从UnifiedReaderViewModel移到TtsService中，使其作为独立的前台服务运行
  2. 在TtsService中实现BookReaderEngine的加载和管理，支持自动翻页功能
  3. 添加resetPageCompletedFlag方法到TtsManager中，用于重置页面完成标志
  4. 优化UnifiedReaderViewModel中的bindTtsService方法，确保正确传递书籍信息
- **改进目的**：使TTS朗读完当前页后能自动翻到下一页并继续朗读，即使用户已退出阅读界面返回到书架页面
- **技术改进**：
  1. 降低了组件间的耦合度，使TTS功能更加独立
  2. 提高了系统稳定性，避免了因UI组件生命周期变化导致的功能中断
  3. 优化了用户体验，使TTS朗读功能更加可靠和连贯

## 2025-06-07：音频播放控件文字优化
- **界面优化**：将音频播放控件中"同步朗读中"文字改为"同步中..."，保持界面简洁
- **优化方案**：
  1. 修改AudioPlayerControl组件，将同步状态下的文字从"同步朗读中"改为"同步中..."
  2. 保持了文字按钮的背景色（浅蓝色）和不可点击状态不变
- **改进目的**：使界面文字更加简洁，提高用户体验

## 版本 1.0.2 (2024-06-XX)

### 修复
- **TTS朗读高亮显示问题**：修复了多段落文本中TTS朗读高亮显示不准确的问题。现在TTS朗读和高亮显示完全同步，确保只有当前朗读的句子被高亮。
- **空行导致的高亮错误**：修复了页面内包含空行时，空行下面的句子也会被错误高亮的问题。现在不再按照段落划分句子序列，而是使用整个页面的句子序列进行TTS朗读和高亮显示。
- **段落划分机制重构**：完全重构了段落划分机制，将整个页面视为一个单一段落，不再进行页面内的段落细分，彻底解决了空行导致的高亮问题。
- **句子分割保留分隔符**：改进了句子分割算法，现在分割后的每个句子都会保留其末尾的分隔符（如句号、感叹号、问号等），使朗读更加自然，高亮显示更加完整。
- **句子匹配逻辑优化**：修复了带有分隔符的句子无法正确匹配的问题，解决了某些页面整页文字被高亮的异常情况。添加了多级匹配策略，即使句子格式有微小差异也能正确匹配。
- 优化了句子分割逻辑，取消了段落划分机制，使用整个页面的句子序列进行TTS朗读和高亮显示。
- 修复了TextUtils导入冲突问题，解决了android.text.TextUtils与com.wanderreads.ebook.util.TextUtils的命名冲突。
- 修复了UtteranceProgressListener的导入引用问题，确保TTS功能正常工作。

### 优化
- 改进了TTS朗读体验，提高了朗读与文本显示的一致性。
- 优化了HighlightedText组件，使其能够正确处理全局句子序列和段落内句子的对应关系。
- 增强了getSentencesForParagraph方法，使其能够更准确地从整个页面的句子序列中找出属于特定段落的句子。
- **朗读语调优化**：通过保留句子末尾的标点符号，使TTS朗读时能够根据不同的标点（如句号、感叹号、问号）调整语调，使朗读更加自然流畅。
- **日志增强**：添加了更详细的日志输出，帮助诊断句子匹配和高亮显示问题。

## 2025-06-06：音频播放控件图标优化
- **界面优化**：将音频播放控件中的停止图标从方形图标更改为❌图标
- **优化方案**：
  1. 修改AudioPlayerControl组件，将Icons.Default.Stop更换为Icons.Default.Close
  2. 保持了图标的尺寸和颜色不变，仅更改图标样式
- **改进目的**：提高停止按钮的视觉辨识度，使用户更容易识别和使用停止功能

## 2025-06-05：全屏阅读界面音频播放控件显示修复
- **问题修复**：修复了在全屏阅读界面错误显示音频播放控件的问题
- **优化方案**：
  1. 修改了音频播放控件的显示逻辑，确保只有在带工具栏的阅读界面才显示音频控件
  2. 优化了TTS状态变化监听逻辑，添加了工具栏显示状态的条件判断
  3. 修改了顶部菜单中"朗读本页"按钮的逻辑，确保只有在工具栏显示时才显示音频控件
  4. 完善了AudioPlayerControl组件的条件判断，添加了工具栏显示状态检查
- **改进目的**：严格遵循产品需求，确保全屏阅读界面提供沉浸式阅读体验，不受音频控件干扰

## 2025-06-02：语音合成页面显示修复
- **问题修复**：修复了点击"开始合成"后语音合成页面消失的问题
- **优化方案**：
  1. 修改了语音合成进度对话框的显示逻辑，确保在合成过程中始终显示进度
  2. 即使在合成状态尚未更新时，也会显示初始的进度对话框，避免用户体验断层
  3. 完善了onProgress回调，确保UI状态及时更新
  4. 优化了对话框的关闭逻辑，只有在合成完成、出错或用户主动取消时才允许关闭
- **改进目的**：提升语音合成功能的用户体验，让用户清晰了解合成进度

## 2025-05-28：统一文件命名规则
- **功能增强**：实现统一的文件命名规则，提高文件管理的一致性和可读性
- **实现内容**：
  1. 创建FileNamingUtil工具类，集中管理所有类型文件的命名规则
  2. 更新新建文本和网址导入文件命名规则：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .md
  3. 更新合成语音文件命名规则：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .mp3
  4. 更新本地导入文件命名规则：原文件名(不含扩展名)前20个字符 + 下划线 + 4位随机数 + .原扩展名
  5. 将网址导入和新建文本的文件扩展名从.txt改为.md，以便后续使用markdown格式解析
- **改进目的**：统一文件命名规则，提高文件管理的一致性，并为后续功能扩展（如markdown支持）做准备

## 2025-05-25：语音合成功能优化
- **问题修复**：修复了选择"当前章节"作为合成范围时出现"语音合成过程中出错"的问题
- **优化方案**：
  1. 实现了大文本分块处理功能，将长文本按自然段落和句子分割成多个小块进行处理（在TtsSynthesisService中添加大文本分块处理功能）
      - 引入了TEXT_CHUNK_SIZE常量（3000字符），用于控制每个文本块的大小
      - 实现了processLargeText方法，将长文本按自然段落和句子分割成多个小块
      - 为分块处理添加了专门的进度跟踪和错误处理逻辑
  2. 添加了文本预处理功能，移除可能导致TTS引擎出错的特殊字符
  3. 优化了错误处理逻辑，当获取章节文本失败时自动降级使用当前页文本
  4. 改进了进度显示，提供更准确的合成进度反馈

## 2025-05-27：文件操作安全优化
- **功能增强**：为文件删除操作添加确认对话框
- **实现内容**：
  1. 在书库二级页面（如语音文件列表）中，删除文件前增加确认步骤
  2. 批量删除时，确认对话框显示"选定的X个文件即将被删除，且不可恢复，是否确认删除？"
  3. 单个文件删除时也显示类似的确认提示
  4. 用户可以选择"确认删除"或"取消"操作
- **改进目的**：防止用户误操作导致重要文件被意外删除

## 2025-05-30：TTS朗读与音频播放控件优化
- **功能增强**：优化TTS朗读体验与音频播放控件交互
- **实现内容**：
  1. 实现TTS朗读作为全局后台服务，翻页或切换应用时朗读不受影响
  2. 创建TtsManager类，全局管理TTS三种状态：停止、朗读、暂停
  3. 引入TtsService前台服务，确保应用切换后台朗读不中断
  4. 优化音频播放控件UI，实现更美观的两端半圆形设计
  5. 增强音频控件交互体验，支持拖动到屏幕任意位置
  6. 优化"朗读本页"按钮状态管理，在朗读状态下自动禁用
  7. 优化内存管理，TTS停止时自动释放相关资源
- **改进目的**：提供更流畅的阅读与聆听体验，使用户可以在阅读的同时享受听书服务

## 2024-07-XX 优化更新

### 代码优化
1. 统一了文本句子分割机制，将所有相关实现集中到 TextUtils 工具类中
   - 优化了 TtsManager、TtsSynthesisService 和 UnifiedReaderScreen 中的文本处理逻辑
   - 添加了专门的段落分割方法 splitTextIntoParagraphs
   - 确保所有文本处理使用统一的正则表达式和算法
   - 提高了代码可维护性和一致性
2. 改进了句子分割正则表达式(SENTENCE_DELIMITER_REGEX)
   - 添加了换行(\n)和回车换行(\r\n)作为句子分隔符
   - 增强了文本分割的准确性，特别是对于包含多种格式的复杂文本

### 功能改进
1. 改进了文本分割算法，更准确地识别中英文句子边界
2. 优化了大文本处理逻辑，提高了TTS语音合成的稳定性
3. 增强了文本朗读体验，现在可以在换行处正确暂停，使朗读更加自然流畅
