# 更新与修复日志

## 2025-06-02：语音合成页面显示修复
- **问题修复**：修复了点击"开始合成"后语音合成页面消失的问题
- **优化方案**：
  1. 修改了语音合成进度对话框的显示逻辑，确保在合成过程中始终显示进度
  2. 即使在合成状态尚未更新时，也会显示初始的进度对话框，避免用户体验断层
  3. 完善了onProgress回调，确保UI状态及时更新
  4. 优化了对话框的关闭逻辑，只有在合成完成、出错或用户主动取消时才允许关闭
- **改进目的**：提升语音合成功能的用户体验，让用户清晰了解合成进度

## 2025-05-28：统一文件命名规则
- **功能增强**：实现统一的文件命名规则，提高文件管理的一致性和可读性
- **实现内容**：
  1. 创建FileNamingUtil工具类，集中管理所有类型文件的命名规则
  2. 更新新建文本和网址导入文件命名规则：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .md
  3. 更新合成语音文件命名规则：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .mp3
  4. 更新本地导入文件命名规则：原文件名(不含扩展名)前20个字符 + 下划线 + 4位随机数 + .原扩展名
  5. 将网址导入和新建文本的文件扩展名从.txt改为.md，以便后续使用markdown格式解析
- **改进目的**：统一文件命名规则，提高文件管理的一致性，并为后续功能扩展（如markdown支持）做准备

## 2025-05-25：语音合成功能优化
- **问题修复**：修复了选择"当前章节"作为合成范围时出现"语音合成过程中出错"的问题
- **优化方案**：
  1. 实现了大文本分块处理功能，将长文本按自然段落和句子分割成多个小块进行处理（在TtsSynthesisService中添加大文本分块处理功能）
      - 引入了TEXT_CHUNK_SIZE常量（3000字符），用于控制每个文本块的大小
      - 实现了processLargeText方法，将长文本按自然段落和句子分割成多个小块
      - 为分块处理添加了专门的进度跟踪和错误处理逻辑
  2. 添加了文本预处理功能，移除可能导致TTS引擎出错的特殊字符
  3. 优化了错误处理逻辑，当获取章节文本失败时自动降级使用当前页文本
  4. 改进了进度显示，提供更准确的合成进度反馈

## 2025-05-27：文件操作安全优化
- **功能增强**：为文件删除操作添加确认对话框
- **实现内容**：
  1. 在书库二级页面（如语音文件列表）中，删除文件前增加确认步骤
  2. 批量删除时，确认对话框显示"选定的X个文件即将被删除，且不可恢复，是否确认删除？"
  3. 单个文件删除时也显示类似的确认提示
  4. 用户可以选择"确认删除"或"取消"操作
- **改进目的**：防止用户误操作导致重要文件被意外删除

## 2025-05-30：TTS朗读与音频播放控件优化
- **功能增强**：优化TTS朗读体验与音频播放控件交互
- **实现内容**：
  1. 实现TTS朗读作为全局后台服务，翻页或切换应用时朗读不受影响
  2. 创建TtsManager类，全局管理TTS三种状态：停止、朗读、暂停
  3. 引入TtsService前台服务，确保应用切换后台朗读不中断
  4. 优化音频播放控件UI，实现更美观的两端半圆形设计
  5. 增强音频控件交互体验，支持拖动到屏幕任意位置
  6. 优化"朗读本页"按钮状态管理，在朗读状态下自动禁用
  7. 优化内存管理，TTS停止时自动释放相关资源
- **改进目的**：提供更流畅的阅读与聆听体验，使用户可以在阅读的同时享受听书服务
