## 2025-07-20 更新日志

### 重要修复
- **阅读设置界面主题适配问题**：修复了阅读界面右下角阅读设置弹出界面在浅色模式下文字看不清楚的问题
  - 将阅读设置界面（UnifiedReaderScreen）中所有文字颜色从硬编码的白色改为动态主题颜色（MaterialTheme.colorScheme.onSurface）
  - 将设置界面背景色从硬编码的readerBackground改为MaterialTheme.colorScheme.surface
  - 将目录界面背景色和文字颜色也改为动态主题颜色，确保主题一致性
  - 浅色模式下设置界面文字现在显示为深蓝色，确保在浅色背景下清晰可见
  - 深色模式下设置界面文字显示为浅色，保持良好的对比度
  - 修复了字体大小、行间距、暗色模式、TTS语速等所有设置项的文字颜色问题

- **顶部标题栏文字垂直居中问题**：修复了书库界面和设置界面顶部标题栏文字不居中的问题
  - 修复了设置界面（SettingsScreen）标题文字"设置"垂直居中问题，使用Box和Alignment.Center包装Text组件
  - 修复了书库界面（LibraryScreen）标题文字"书库"垂直居中问题，使用Box和Alignment.Center包装Text组件
  - 修复了文件列表界面（FileListScreen）标题文字垂直居中问题，使用Box和Alignment.Center包装Text组件
  - 修复了合成语音列表界面（SynthesizedAudioListScreen）标题文字垂直居中问题，使用Box和Alignment.Center包装Text组件
  - 修复了阅读器界面（ReaderScreen）标题文字垂直居中问题，使用Box和Alignment.Center包装Text组件
  - 添加了必要的import语句（fillMaxHeight）以支持垂直居中布局
  - 现在所有界面的标题文字都能在TopAppBar中完美垂直居中显示，提升了界面美观度

## 2024-07-20 更新日志

### 重要修复
- **书库和设置界面顶部标题栏背景色缺失问题**：修复了书库界面和设置界面顶部标题栏缺少背景色的问题
  - 为书库界面（LibraryScreen）的TopAppBar添加了与书架界面一致的蓝色背景（#1565C0）
  - 为设置界面（SettingsScreen）的TopAppBar添加了与书架界面一致的蓝色背景（#1565C0）
  - 为书库文件列表界面（FileListScreen）的TopAppBar添加了与书架界面一致的蓝色背景（#1565C0）
  - 统一了所有界面的标题栏样式，包括背景色、文字颜色、图标颜色、高度和阴影效果
  - 修复了选择模式下图标和文字的颜色显示问题，确保在蓝色背景下清晰可见

- **阅读界面弹出菜单主题适配问题**：修复了阅读界面右上角三个点弹出菜单在浅色模式下菜单项文字看不清楚的问题
  - 将所有菜单项的文字颜色从硬编码的白色改为动态主题颜色（MaterialTheme.colorScheme.onSurface）
  - 将所有菜单项的图标颜色从硬编码的白色改为动态主题颜色（MaterialTheme.colorScheme.onSurface）
  - 将菜单背景色从硬编码的readerBackground改为MaterialTheme.colorScheme.surface
  - 浅色模式下菜单项文字现在显示为深蓝色，确保在浅色背景下清晰可见
  - 深色模式下菜单项文字显示为浅色，保持良好的对比度

### 技术改进
- 统一了应用中所有TopAppBar的样式配置，确保界面一致性
- 添加了必要的import语句（Color、shadow等）以支持新的样式设置
- 在UnifiedReaderScreen中添加了menuTextColor和menuIconColor变量，统一管理菜单颜色
- 更新了所有DropdownMenuItem的text和leadingIcon颜色设置，使用主题颜色替代硬编码颜色
- 确保菜单在不同主题模式下都能提供良好的视觉体验和可读性

## 2024-07-19 更新日志

### 重要修复
- **文本文件导入totalPages字段为0的问题**：修复了导入文本文件后数据库中totalPages字段为0导致阅读进度显示为0%的问题
  - 修复了网页导入功能中没有设置totalPages字段的问题
  - 修复了OCR导入功能中没有设置totalPages字段的问题
  - 修复了新建文本功能中没有设置totalPages字段的问题
  - 修复了BookshelfViewModel.addBook方法中没有设置totalPages字段的问题
  - 为BookshelfViewModel添加了estimateBookPages方法，用于估算不同格式文件的页数
  - 统一使用每2000字符算一页的标准来计算TXT文件页数

### 技术改进
- 在所有创建Book对象的地方添加了totalPages字段的正确计算
- 确保TXT、MD等文本格式文件都能正确计算页数
- 统一了页数估算算法：TXT文件每2000字符一页，PDF文件每50KB一页，EPUB文件每100KB一章
- 修复了阅读进度计算公式：readingProgress = lastReadPage / totalPages

## 2024-07-19 更新日志（早期）

### 修复
- **阅读界面主题适配问题**：修复了阅读界面在浅色模式下背景颜色不正确的问题
  - 将硬编码的深蓝色背景（#0A1929）替换为动态主题背景色
  - 浅色模式下现在正确显示暖白色背景（#F9F6F0）
  - 深色模式下显示墨蓝色背景（#0A1929）
- **HTML内容主题适配**：修复了WebView中HTML内容的主题颜色问题
  - HTML样式中的背景色和文字色现在根据主题动态设置
  - 确保HTML内容与应用主题保持一致
- **纯文本内容主题适配**：修复了TXT等纯文本格式的主题颜色问题
  - 纯文本内容的背景色和文字色现在正确使用主题颜色
  - HighlightedText组件已正确使用MaterialTheme.colorScheme.onBackground

### 技术改进
- 在UnifiedReaderScreen中使用MaterialTheme.colorScheme.background和onBackground替代硬编码颜色
- 添加了动态CSS样式生成，根据主题颜色生成对应的十六进制颜色值
- 统一了所有阅读界面组件的主题颜色使用方式
- 确保WebView、纯文本内容、弹出菜单等所有界面元素都正确应用主题颜色

## 2024-07-22 更新日志

### 功能优化
- **书架管理功能提示**：为书架管理功能添加了"功能开发中，敬请期待..."的提示信息，提升用户体验
- **UI交互改进**：点击书架界面右上角菜单中的"书架管理"选项时，会显示友好的开发中提示
- **用户反馈优化**：通过Toast消息提示用户功能正在开发中，避免用户困惑

### 技术改进
- 在BookshelfViewModel中添加showFeatureInDevelopmentMessage方法，用于显示功能开发中的提示
- 在BookshelfScreen中添加UI事件收集器，处理并显示Toast消息
- 优化了用户交互流程，确保用户点击未完成功能时能得到及时反馈

## 2024-07-21 更新日志

### 技术改进
- **图片裁剪库替换**：将 ImageCropView 库替换为更稳定的 ArthurHub 的 Android-Image-Cropper 2.8.0 库
- **兼容性提升**：新的图片裁剪库与项目中的 Kotlin 1.9.22、core-ktx 1.10.1、Room 2.6.1 和 compileSdk 34 完全兼容
- **裁剪界面优化**：重构了图片裁剪界面，使用原生 Android 界面进行裁剪操作，提供更流畅的用户体验
- **功能完整保留**：在替换裁剪库的同时保留了原有的所有功能，包括自由裁剪、边框调整等

## 2024-07-20 更新日志

### 功能增强
- **拍照导入图片裁剪功能**：在拍照或从相册选择图片后，增加了图片裁剪步骤，用户可以调整照片边框大小和位置，确认后才开始进行OCR识别
- **提升用户体验**：通过图片裁剪功能，用户可以精确选择需要识别的区域，提高OCR识别准确率

### 技术改进
- 添加了ImageCropView 2.8.0库来实现图片裁剪功能
- 创建了新的ImageCropScreen界面，使用Android View Interoperability集成第三方裁剪控件
- 重构OcrImportViewModel和OcrImportScreen，添加了图片裁剪相关的状态和逻辑
- 优化了图片处理流程，拍照或选择图片后先进入裁剪界面，裁剪完成后再进行OCR识别

## 2024-07-18 更新日志

### 功能优化
- **OCR文本处理优化**：实现了OCR提取文本的换行符处理规则，如果换行符右边是2个空格或TAB符，则保留换行符，否则剔除掉换行符
- **文本格式提升**：优化了OCR识别文本的格式，提高了文本的可读性，特别是对于包含段落和缩进的文本内容

### 技术改进
- 新增OcrLineProcessor工具类，专门处理OCR提取文本中的换行符
- 在OcrTextExtractor中集成了换行符处理逻辑，确保所有OCR提取的文本都经过统一处理
- 添加了单元测试OcrLineProcessorTest，验证换行符处理规则的正确实现
- 保持了与新建文本处理逻辑的一致性，确保用户体验的统一

## 2024-07-17 更新日志

### 界面优化
- **本地导入界面优化**：移除了本地导入界面中的"拍照导入"按钮，因为拍照导入功能已经有专门的菜单入口
- **简化用户界面**：通过移除重复功能按钮，使界面更加简洁明了，减少用户操作的混淆

### 技术改进
- 修改了ImportBookScreen.kt文件，移除了"拍照导入"按钮
- 保留了"选择文件导入"按钮的功能，确保用户仍然可以方便地导入本地文件

## 2024-07-16 更新日志

### 问题修复
- **网址导入功能修复**：修复了点击"网址导入"按钮后没有反应的问题
- **WebImportDialog优化**：改进了网址导入对话框的焦点处理和占位符逻辑
- **网络请求增强**：优化了网页获取逻辑，现在支持处理更多类型的网页和HTTP状态码
- **错误处理完善**：添加了更详细的错误提示，包括404、403等常见HTTP错误的友好提示

### 技术改进
- 将DisposableEffect替换为LaunchedEffect，解决了焦点请求问题
- 修改了JSoup配置，启用ignoreHttpErrors和ignoreContentType选项，提高网页获取成功率
- 优化了占位符URL示例，使用更通用的example.com
- 增强了错误处理逻辑，添加了针对常见HTTP错误和网络问题的具体错误提示
- 修复了网址导入对话框在BookshelfScreen中的显示问题

## 2024-07-15 更新日志

### 功能优化
- **系统文件管理器集成**：改进了书库中的文件浏览功能，现在点击文件夹图标会打开系统自带的文件管理器，而不是应用内的文件选择器
- **文件定位优化**：优化了文件所在目录的打开方式，现在会直接使用系统文件管理器打开文件所在目录，支持文件的直接播放和管理
- **多厂商适配**：针对不同厂商的设备进行了适配，包括通用Android、三星、华为、小米、OPPO、VIVO等主流设备的文件管理器

### 技术改进
- 重构了openFileExplorer和openFileLocation方法，优先使用系统文件管理器打开目录
- 添加了多种备用方案，确保在不同设备上都能成功打开文件管理器
- 优化了文件URI构建方式，提高了打开成功率
- 添加详细日志记录，便于问题诊断和后续优化

## 2024-07-10 更新日志

### 功能优化
- **闹钟铃声设置优化**：改进了设置闹钟功能，现在会将语音文件自动复制到Music/ringtone目录下，并立即刷新媒体库，使系统能够识别新添加的铃声文件
- **自动创建目录**：当ringtone目录不存在时，会自动创建该目录，确保文件复制操作成功
- **错误处理增强**：添加了更完善的错误处理机制，当文件复制失败时会向用户显示明确的错误提示

### 技术改进
- 将铃声文件从原先的DIRECTORY_RINGTONES/SoundSync更改为DIRECTORY_MUSIC/ringtone
- 使用MediaScannerConnection.scanFile立即通知媒体库刷新，确保系统能够识别到新音频文件
- 简化铃声目录创建逻辑，减少冗余代码，提高代码可维护性
- 在SynthesizedAudioListScreen中添加Toast提示，优化用户体验

## 2024-07-09 更新日志

### 新增功能
- **合成语音列表界面增强**：在合成语音列表播放工具栏中添加三个点菜单图标，点击后弹出子菜单，包括"所属目录"和"设置闹钟"两个选项
- **功能共享**：复用书库中语音文件列表的"所属目录"和"设置闹钟"功能代码，保持一致的用户体验

### 技术改进
- 在AudioControlPanel组件中添加三个点菜单按钮和相应的下拉菜单
- 添加onOpenFileLocation和onSetAlarm回调函数，实现文件目录打开和闹钟设置功能
- 优化了文件目录打开功能，使用Intent.ACTION_VIEW和Intent.createChooser提供更好的文件浏览器选择体验
- 完善了设置闹钟功能，使用FileProvider安全共享语音文件，并为常见闹钟应用授予访问权限

## 2024-07-08 更新日志

### 新增功能
- **Word文件支持**：添加对Word文档(DOC/DOCX)格式的支持，系统会自动提取Word文件中的文本内容，并以TXT格式保存，方便用户阅读和使用TTS朗读功能
- **文件格式扩展**：扩展了BookFormat枚举，增加了DOC和DOCX格式的识别
- **文件类型扩展**：在BookType枚举中添加了WORD类型，用于标识Word文档

### 技术改进
- 创建WordTextExtractor工具类，使用Apache POI库提取Word文档(DOC/DOCX)中的文本内容
- 扩展MetadataExtractor类，增加对Word文档元数据的提取支持
- 优化BookImportWorker工作流程，添加对Word文档的处理逻辑
- 添加Apache POI相关依赖库，用于处理Word文档格式

## 2024-07-01 更新日志

### 新增功能
- **PDF文本提取功能**：增强PDF导入功能，现在系统会自动从PDF文件中提取文本内容，并以TXT格式保存，使用户可以像阅读TXT文件一样阅读和使用TTS朗读功能
- **原始文件路径记录**：为从PDF提取的TXT文件添加原始PDF文件路径记录，保证文件溯源关系完整

### 技术改进
- 创建PdfTextExtractor工具类，使用tom-roush的PDFBox库提取PDF文本内容
- 优化BookImportWorker工作流程，在PDF处理过程中添加文本提取和保存步骤
- 增强BookEntity和Book模型，添加originalFilePath字段支持
- 数据库版本升级到v7，支持存储原始文件路径信息

## 2024-05-30 更新日志

### 新增功能
- **书架界面音频播放控件**：当TTS朗读状态为播放或暂停时，在书架界面底部导航栏上方显示音频播放控件，用户可以控制TTS朗读，并通过"边听边看"按钮快速跳转到正在朗读的页面

### 优化
- 优化了音频播放控件的显示逻辑，使其在全局TTS状态变化时自动显示或隐藏
- 实现了音频播放控件在书架界面和阅读界面的统一体验

## 更新日志

### 2024-06-XX 版本 0.XX
1. 书架菜单增加批量操作功能
   - 在书架页面右上角三点菜单的最下方增加"批量操作"选项
   - 点击"批量操作"后进入批量选择模式，效果等同于长按书籍
   - 在批量选择模式下，用户可以选择多本书籍，进行批量删除等操作
   - 使用BookshelfViewModel中的toggleSelectionMode方法实现批量选择模式切换
   - 为三点菜单添加分隔线，使批量操作选项与其他选项视觉上区分开来

### 2024-05-XX 版本 0.XX
1. 语音文件设置闹钟功能
   - 在语音文件列表中，点击文件右侧的"..."菜单，新增"设置闹钟"选项
   - 点击后可调用系统自带的时钟程序的闹钟设置界面
   - 自动将选中的语音文件设置为闹钟铃声
   - 支持主流Android设备的闹钟应用，包括原生Android、Google、三星、华为、OPPO、vivo等品牌
   - 实现方法：
     1. 使用FileProvider安全共享语音文件
     2. 通过AlarmClock.ACTION_SET_ALARM Intent调用系统闹钟设置
     3. 添加com.android.alarm.permission.SET_ALARM权限确保功能正常工作
     4. 自动授予相关闹钟应用访问语音文件的权限
     5. 设置默认闹钟时间为早上8:00，用户可在闹钟设置界面修改
     6. 添加详细错误处理和日志记录，确保功能稳定可靠

2. 文件浏览器定位问题修复
   - 修复了书库界面点击文件夹图标时，文件浏览器默认定位到Download目录而非指定目录的问题
   - 优化了文件浏览器打开逻辑，添加多层备用方案确保能够正确定位到Documents\SoundSync目录
   - 实现方法：
     1. 使用ACTION_GET_CONTENT替代ACTION_OPEN_DOCUMENT_TREE，提高目录定位成功率
     2. 使用DocumentsContract.EXTRA_INITIAL_URI正确设置初始目录
     3. 添加多层备用方案，包括ACTION_OPEN_DOCUMENT、ACTION_OPEN_DOCUMENT_TREE等
     4. 针对不同Android版本优化URI构建方式
     5. 添加详细日志记录，便于问题诊断
   - 改进了"新建文本"、"网址导入"、"本地导入"和"语音文件"四个类别的文件浏览器定位

3. 书架批量选择模式返回键行为优化
   - 修复了书架界面在批量选择模式下，点击返回键会直接退出应用的问题
   - 现在点击返回键会先退出选择模式，而不是直接退出app
   - 通过在BookshelfScreen中添加BackHandler组件拦截系统返回键事件，实现更符合用户预期的交互体验
4. 语音列表返回键行为修复
   - 修复了在阅读界面点击语音列表图标进入语音列表界面后，通过系统返回键返回时会跳转到书架界面的问题
   - 现在点击返回键会正确返回到阅读界面，符合用户预期的导航逻辑
   - 通过添加BackHandler组件拦截系统返回键事件，确保返回时调用正确的onDismiss回调函数
5. 书库二级界面返回键行为修复
   - 修复了在书库二级界面（如"新建文本"文件列表）通过系统返回键返回时，会跳转到书架界面的问题
   - 现在点击返回键会正确返回到书库一级界面，符合用户预期的导航逻辑
   - 优化了文件列表选择模式下的返回键行为，先退出选择模式，再返回上一级
6. 新增后台运行管理功能
   - 增加"允许后台运行"设置选项，支持跳转到厂商特定设置界面
   - 智能识别华为、小米、OPPO、VIVO等主流设备，自动跳转对应设置
   - 添加开机自启动功能，支持设备重启后自动恢复TTS服务
7. 权限优化
   - 添加WAKE_LOCK权限，确保后台处理任务不被系统休眠
   - 添加RECEIVE_BOOT_COMPLETED权限，支持开机自启动
   - 添加SCHEDULE_EXACT_ALARM权限，支持精确闹钟功能
8. 文档更新
   - 在README中新增后台运行功能说明章节
   - 详细说明各厂商设备的后台运行设置方法

## 2025-07-15：书籍列表批量操作功能
- **功能增强**：为书籍列表添加批量操作功能
- **实现内容**：
  1. 长按书籍可触发批量操作模式，每本书右侧显示复选框
  2. 顶部导航栏替换为批量操作工具栏，包含批量删除、全选/取消全选和取消按钮
  3. 批量删除支持选择是否同时删除书籍文件
  4. 实现全选/取消全选功能，方便用户快速选择
  5. 优化了选择状态的视觉反馈，选中的书籍使用不同背景色
- **改进目的**：提升用户管理大量书籍的效率，简化批量删除操作
- **技术改进**：
  1. 在BookshelfViewModel中实现批量操作状态管理
  2. 优化UI组件实现批量选择的视觉反馈
  3. 实现安全的批量删除机制，包含确认对话框和文件删除选项

## 2025-07-10：添加电池优化设置功能
- **功能增强**：在设置界面添加"关闭电池优化"开关
- **实现内容**：
  1. 在设置界面的"其他"分类下添加电池优化开关
  2. 用户开启后，自动跳转到系统设置界面请求忽略电池优化
  3. 实时显示当前电池优化状态
  4. 添加REQUEST_IGNORE_BATTERY_OPTIMIZATIONS权限
- **改进目的**：提高TTS朗读服务在后台的稳定性，避免系统电池优化导致的服务中断
- **技术改进**：
  1. 使用PowerManager.isIgnoringBatteryOptimizations检查当前状态
  2. 通过Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS Intent跳转到系统设置
  3. 使用DataStore保存用户设置，确保设置持久化

## 2025-07-05：打开网址功能实现
- **功能增强**：在阅读界面添加"打开网址"功能
- **实现内容**：
  1. 在阅读界面的三点菜单中添加"打开网址"选项，仅当书籍的urlPath字段不为空时显示
  2. 点击后使用WebView打开对应网址，提供完整的网页浏览体验
  3. 在WebView页面添加顶部工具栏，显示网页标题和返回按钮
  4. 支持网页内容的TTS朗读功能
  5. 点击页面可以切换工具栏的显示状态
- **改进目的**：增强网址导入书籍的功能，让用户可以方便地查看原始网页内容
- **技术改进**：
  1. 利用现有的WebView组件和导航系统实现功能
  2. 根据书籍的urlPath字段动态显示菜单选项
  3. 保持一致的用户界面风格和交互体验

## 2025-06-30：阅读设置界面优化
- **界面优化**：将TTS语速设置从设置界面迁移到阅读界面设置中
- **实现内容**：
  1. 将TTS语速设置移动到阅读界面设置对话框中的行间距设置下方
  2. 移除了"TTS朗读设置"标题，使界面更加简洁
  3. 保留了语速调节滑块、说明文字和测试按钮的功能
- **改进目的**：优化用户体验，使用户可以在阅读过程中直接调整TTS语速，无需跳转到单独的设置界面

## 2025-06-28：通知栏优化
- **功能优化**：移除通知栏中的语音合成信息
- **实现内容**：
  1. 修改TtsSynthesisService，使语音合成服务在后台静默运行
  2. 将通知渠道重要性从IMPORTANCE_LOW降级为IMPORTANCE_MIN
  3. 设置通知优先级为PRIORITY_MIN，使其不显示在通知栏
  4. 禁用通知徽章显示和锁屏通知
- **改进目的**：简化通知栏体验，只保留TTS朗读相关的通知，避免多个通知造成的混淆
- **技术改进**：
  1. 保留了前台服务功能，确保语音合成在后台正常运行
  2. 优化了通知状态更新机制，不再向系统通知栏发送更新

## 2025-06-25：TTS通知栏功能增强
- **功能增强**：改进TTS朗读通知栏功能
- **实现内容**：
  1. 优化通知点击行为，点击通知现在会直接跳转到正在朗读的书籍页面
  2. 在通知栏添加播放/暂停和停止按钮，方便用户直接控制TTS朗读
  3. 创建TtsNotificationReceiver处理通知按钮的点击事件
  4. 添加相应的图标资源：ic_play.xml、ic_pause.xml和ic_stop.xml
  5. 修改MainActivity，处理从通知点击跳转的逻辑
- **改进目的**：提升用户体验，让用户可以在不打开应用的情况下控制TTS朗读
- **技术改进**：
  1. 使用PendingIntent实现通知操作
  2. 通过BroadcastReceiver处理通知按钮点击事件
  3. 优化通知内容展示，更清晰地显示当前朗读状态

## 2025-06-22：添加Markdown文件支持
- **功能增强**：添加对.md扩展名文件的支持
- **实现内容**：
  1. 在BookFormat枚举类中添加MD格式
  2. 在BookType枚举类中添加MD类型
  3. 更新ReaderEngineFactory，使用TxtReaderEngine处理.md文件
  4. 更新MetadataExtractor，使用与TXT相同的元数据提取方法处理.md文件
  5. 更新determineBookType方法，支持识别.md扩展名
- **改进目的**：扩展应用支持的文件格式，提供更全面的电子书导入功能
- **技术改进**：
  1. 复用现有TXT处理逻辑，确保代码的一致性和可维护性
  2. 为后续可能的Markdown格式特殊处理奠定基础

## 2025-06-20：TTS设置界面集成
- **功能增强**：添加TTS设置界面，允许用户自定义TTS朗读参数
- **实现内容**：
  1. 创建了TtsSettingsScreen组件，使用Jetpack Compose实现现代化UI界面
  2. 在设置页面添加"TTS朗读设置"入口，方便用户访问
  3. 支持调整以下TTS参数：
     - 语速：范围0.5-2.0，控制朗读速度
     - 音量：范围0.0-1.0，控制朗读音量
     - 句子间停顿时间：范围0-100，控制句子之间的停顿长度
  4. 添加"测试朗读效果"按钮，让用户可以即时听到设置效果
  5. 实现设置的自动保存，确保下次朗读时自动应用用户偏好
  6. 修复了TtsSettings和TtsManager中的常量引用错误
- **改进目的**：提供更加个性化的朗读体验，满足不同用户的需求和偏好
- **技术改进**：
  1. 使用Jetpack Compose实现了响应式UI，提供流畅的用户体验
  2. 优化了TTS参数应用机制，确保设置能够即时生效
  3. 修复了Android TTS参数设置相关的bug

## 2025-06-15：TTS自动翻页同步状态修复
- **问题修复**：修复TTS朗读完一页自动翻页后同步状态(IsSyncPageState)错误变为0的问题
- **实现内容**：
  1. 优化TtsService中的handlePageCompleted方法，在同步状态下(IsSyncPageState=1)：
     - 先发送广播通知前端UI更新
     - 等待300毫秒确保UI已更新
     - 更新全局阅读位置
     - 然后再开始朗读新页面
  2. 增强TtsManager中的updateSyncPageState方法，添加更详细的日志记录
  3. 改进TtsManager中的startReading方法，检测并修复同步状态从1变为0的情况
- **改进目的**：确保在TTS自动翻页后，如果之前是同步状态(IsSyncPageState=1)，则保持同步状态，使前端UI与TTS朗读位置始终保持一致

## 2025-06-12：TTS自动翻页规则优化
- **功能增强**：优化TTS自动翻页规则，根据同步状态智能决定UI行为
- **实现内容**：
  1. 添加基于IsSyncPageState的翻页逻辑判断：
     - 当IsSyncPageState=1（朗读页面与用户查看的页面一致）时，TTS自动翻页会同步更新UI
     - 当IsSyncPageState=0（朗读页面与用户查看的页面不一致）时，TTS在后台自动翻页，不影响前端UI
  2. 实现广播机制，在需要时通知前端UI更新页面
  3. 优化TtsService中的handlePageCompleted方法，增强日志记录
  4. 在UnifiedReaderViewModel中添加广播接收器处理翻页通知
- **改进目的**：提供更加智能的阅读体验，在用户专注阅读时不打扰，在用户使用TTS跟读时保持同步

## 2025-06-10：TTS自动翻页功能优化
- **功能增强**：优化TTS自动翻页机制，使其生命周期不依赖于特定的ViewModel或UI界面
- **实现内容**：
  1. 将自动翻页逻辑从UnifiedReaderViewModel移到TtsService中，使其作为独立的前台服务运行
  2. 在TtsService中实现BookReaderEngine的加载和管理，支持自动翻页功能
  3. 添加resetPageCompletedFlag方法到TtsManager中，用于重置页面完成标志
  4. 优化UnifiedReaderViewModel中的bindTtsService方法，确保正确传递书籍信息
- **改进目的**：使TTS朗读完当前页后能自动翻到下一页并继续朗读，即使用户已退出阅读界面返回到书架页面
- **技术改进**：
  1. 降低了组件间的耦合度，使TTS功能更加独立
  2. 提高了系统稳定性，避免了因UI组件生命周期变化导致的功能中断
  3. 优化了用户体验，使TTS朗读功能更加可靠和连贯

## 2025-06-07：音频播放控件文字优化
- **界面优化**：将音频播放控件中"同步朗读中"文字改为"同步中..."，保持界面简洁
- **优化方案**：
  1. 修改AudioPlayerControl组件，将同步状态下的文字从"同步朗读中"改为"同步中..."
  2. 保持了文字按钮的背景色（浅蓝色）和不可点击状态不变
- **改进目的**：使界面文字更加简洁，提高用户体验

## 版本 1.0.2 (2024-06-XX)

### 修复
- **TTS朗读高亮显示问题**：修复了多段落文本中TTS朗读高亮显示不准确的问题。现在TTS朗读和高亮显示完全同步，确保只有当前朗读的句子被高亮。
- **空行导致的高亮错误**：修复了页面内包含空行时，空行下面的句子也会被错误高亮的问题。现在不再按照段落划分句子序列，而是使用整个页面的句子序列进行TTS朗读和高亮显示。
- **段落划分机制重构**：完全重构了段落划分机制，将整个页面视为一个单一段落，不再进行页面内的段落细分，彻底解决了空行导致的高亮问题。
- **句子分割保留分隔符**：改进了句子分割算法，现在分割后的每个句子都会保留其末尾的分隔符（如句号、感叹号、问号等），使朗读更加自然，高亮显示更加完整。
- **句子匹配逻辑优化**：修复了带有分隔符的句子无法正确匹配的问题，解决了某些页面整页文字被高亮的异常情况。添加了多级匹配策略，即使句子格式有微小差异也能正确匹配。
- 优化了句子分割逻辑，取消了段落划分机制，使用整个页面的句子序列进行TTS朗读和高亮显示。
- 修复了TextUtils导入冲突问题，解决了android.text.TextUtils与org.soundsync.ebook.util.TextUtils的命名冲突。
- 修复了UtteranceProgressListener的导入引用问题，确保TTS功能正常工作。

### 优化
- 改进了TTS朗读体验，提高了朗读与文本显示的一致性。
- 优化了HighlightedText组件，使其能够正确处理全局句子序列和段落内句子的对应关系。
- 增强了getSentencesForParagraph方法，使其能够更准确地从整个页面的句子序列中找出属于特定段落的句子。
- **朗读语调优化**：通过保留句子末尾的标点符号，使TTS朗读时能够根据不同的标点（如句号、感叹号、问号）调整语调，使朗读更加自然流畅。
- **日志增强**：添加了更详细的日志输出，帮助诊断句子匹配和高亮显示问题。

## 2025-06-06：音频播放控件图标优化
- **界面优化**：将音频播放控件中的停止图标从方形图标更改为❌图标
- **优化方案**：
  1. 修改AudioPlayerControl组件，将Icons.Default.Stop更换为Icons.Default.Close
  2. 保持了图标的尺寸和颜色不变，仅更改图标样式
- **改进目的**：提高停止按钮的视觉辨识度，使用户更容易识别和使用停止功能

## 2025-06-05：全屏阅读界面音频播放控件显示修复
- **问题修复**：修复了在全屏阅读界面错误显示音频播放控件的问题
- **优化方案**：
  1. 修改了音频播放控件的显示逻辑，确保只有在带工具栏的阅读界面才显示音频控件
  2. 优化了TTS状态变化监听逻辑，添加了工具栏显示状态的条件判断
  3. 修改了顶部菜单中"朗读本页"按钮的逻辑，确保只有在工具栏显示时才显示音频控件
  4. 完善了AudioPlayerControl组件的条件判断，添加了工具栏显示状态检查
- **改进目的**：严格遵循产品需求，确保全屏阅读界面提供沉浸式阅读体验，不受音频控件干扰

## 2025-06-02：语音合成页面显示修复
- **问题修复**：修复了点击"开始合成"后语音合成页面消失的问题
- **优化方案**：
  1. 修改了语音合成进度对话框的显示逻辑，确保在合成过程中始终显示进度
  2. 即使在合成状态尚未更新时，也会显示初始的进度对话框，避免用户体验断层
  3. 完善了onProgress回调，确保UI状态及时更新
  4. 优化了对话框的关闭逻辑，只有在合成完成、出错或用户主动取消时才允许关闭
- **改进目的**：提升语音合成功能的用户体验，让用户清晰了解合成进度

## 2025-05-28：统一文件命名规则
- **功能增强**：实现统一的文件命名规则，提高文件管理的一致性和可读性
- **实现内容**：
  1. 创建FileNamingUtil工具类，集中管理所有类型文件的命名规则
  2. 更新新建文本和网址导入文件命名规则：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .md
  3. 更新合成语音文件命名规则：书名前18个字符 + 下划线 + 年份后2位 + 月份(2位) + 日(2位) + 4位随机数 + .mp3
  4. 更新本地导入文件命名规则：原文件名(不含扩展名)前20个字符 + 下划线 + 4位随机数 + .原扩展名
  5. 将网址导入和新建文本的文件扩展名从.txt改为.md，以便后续使用markdown格式解析
- **改进目的**：统一文件命名规则，提高文件管理的一致性，并为后续功能扩展（如markdown支持）做准备

## 2025-05-25：语音合成功能优化
- **问题修复**：修复了选择"当前章节"作为合成范围时出现"语音合成过程中出错"的问题
- **优化方案**：
  1. 实现了大文本分块处理功能，将长文本按自然段落和句子分割成多个小块进行处理（在TtsSynthesisService中添加大文本分块处理功能）
      - 引入了TEXT_CHUNK_SIZE常量（3000字符），用于控制每个文本块的大小
      - 实现了processLargeText方法，将长文本按自然段落和句子分割成多个小块
      - 为分块处理添加了专门的进度跟踪和错误处理逻辑
  2. 添加了文本预处理功能，移除可能导致TTS引擎出错的特殊字符
  3. 优化了错误处理逻辑，当获取章节文本失败时自动降级使用当前页文本
  4. 改进了进度显示，提供更准确的合成进度反馈

## 2025-05-27：文件操作安全优化
- **功能增强**：为文件删除操作添加确认对话框
- **实现内容**：
  1. 在书库二级页面（如语音文件列表）中，删除文件前增加确认步骤
  2. 批量删除时，确认对话框显示"选定的X个文件即将被删除，且不可恢复，是否确认删除？"
  3. 单个文件删除时也显示类似的确认提示
  4. 用户可以选择"确认删除"或"取消"操作
- **改进目的**：防止用户误操作导致重要文件被意外删除

## 2025-05-30：TTS朗读与音频播放控件优化
- **功能增强**：优化TTS朗读体验与音频播放控件交互
- **实现内容**：
  1. 实现TTS朗读作为全局后台服务，翻页或切换应用时朗读不受影响
  2. 创建TtsManager类，全局管理TTS三种状态：停止、朗读、暂停
  3. 引入TtsService前台服务，确保应用切换后台朗读不中断
  4. 优化音频播放控件UI，实现更美观的两端半圆形设计
  5. 增强音频控件交互体验，支持拖动到屏幕任意位置
  6. 优化"朗读本页"按钮状态管理，在朗读状态下自动禁用
  7. 优化内存管理，TTS停止时自动释放相关资源
- **改进目的**：提供更流畅的阅读与聆听体验，使用户可以在阅读的同时享受听书服务

## 2024-07-XX 优化更新

### 代码优化
1. 统一了文本句子分割机制，将所有相关实现集中到 TextUtils 工具类中
   - 优化了 TtsManager、TtsSynthesisService 和 UnifiedReaderScreen 中的文本处理逻辑
   - 添加了专门的段落分割方法 splitTextIntoParagraphs
   - 确保所有文本处理使用统一的正则表达式和算法
   - 提高了代码可维护性和一致性
2. 改进了句子分割正则表达式(SENTENCE_DELIMITER_REGEX)
   - 添加了换行(\n)和回车换行(\r\n)作为句子分隔符
   - 增强了文本分割的准确性，特别是对于包含多种格式的复杂文本

### 功能改进
1. 改进了文本分割算法，更准确地识别中英文句子边界
2. 优化了大文本处理逻辑，提高了TTS语音合成的稳定性
3. 增强了文本朗读体验，现在可以在换行处正确暂停，使朗读更加自然流畅

## 2024年6月更新
- 添加了网址导入HTML转MD格式的技术实现文档，详细说明了从网页获取内容、解析HTML、格式化文本到保存文件的完整流程。
- 文档包含了针对不同Android版本的存储策略、异常处理机制和文本优化处理方法。

## 2023年12月10日 更新日志

1. 语音文件闹钟设置功能增强
   - 优化了语音文件设置为闹钟铃声的功能
   - 解决了某些设备闹钟无法识别语音文件的问题
   - 现在会自动将语音文件复制到系统铃声目录(Ringtones)并刷新媒体库
   - 复制的文件保存在Ringtones/SoundSync目录下，便于管理
   - 通过MediaScannerConnection.scanFile立即刷新媒体库，确保系统能及时识别
   - 支持更多设备的闹钟应用，大幅提高兼容性
   - 当系统无法创建指定目录时会尝试备用路径，进一步提高成功率

## 2024年7月17日更新
1. 统一了设置闹钟的用户体验
   - 在阅读界面的合成语音列表中设置闹钟时也会弹出确认对话框
   - 与书库中的语音文件列表设置闹钟体验保持一致
   - 提高了用户操作的一致性和可预测性

## 2025-06-15
### 修复
- 修复了在书库界面点击文件夹图标打开文件管理工具失败的问题
  - 原因：Android 7.0及以上版本不允许直接通过file://URI共享文件给其他应用
  - 解决方案：优先使用FileProvider生成content URI，而不是直接使用file URI
  - 修改了LibraryViewModel中的openFileExplorer和openFileLocation方法
- 修复了文件浏览器无法正确打开的问题
  - 原因：MIME类型"resource/folder"不是标准的目录MIME类型
  - 解决方案：将MIME类型更改为标准的"vnd.android.document/directory"
  - 添加了ACTION_GET_CONTENT作为备用打开方式，提高了兼容性
